class LocalSearch{constructor({path:e="",unescape:t=!1,top_n_per_article:n=1}){this.path=e,this.unescape=t,this.top_n_per_article=n,this.isfetched=!1,this.datas=null}getIndexByWord(e,s,i=!1){let a=[],o=new Set;return i||(s=s.toLowerCase()),e.forEach(n=>{if(this.unescape){let e=document.createElement("div");e.innerText=n,n=e.innerHTML}var r=n.length;if(0!==r){let e=0,t;for(i||(n=n.toLowerCase());-1<(t=s.indexOf(n,e));)a.push({position:t,word:n}),o.add(n),e=t+r}}),a.sort((e,t)=>e.position!==t.position?e.position-t.position:t.word.length-e.word.length),[a,o]}mergeIntoSlice(e,t,n){let r=n[0],{position:s,word:i}=r;for(var a=[],o=new Set;s+i.length<=t&&0!==n.length;){o.add(i),a.push({position:s,length:i.length});let e=s+i.length;for(n.shift();0!==n.length&&(r=n[0],s=r.position,i=r.word,e>s);)n.shift()}return{hits:a,start:e,end:t,count:o.size}}highlightKeyword(e,t){let n="",r=t.start;for(var{position:s,length:i}of t.hits)n+=e.substring(r,s),r=s+i,n+=`<mark class="search-keyword">${e.substr(s,i)}</mark>`;return n+=e.substring(r,t.end)}getResultItems(c){let d=[];return this.datas.forEach(({title:e,content:i,url:n})=>{var[r,a]=this.getIndexByWord(c,e),[o,l]=this.getIndexByWord(c,i),a=new Set([...a,...l]).size,l=r.length+o.length;if(0!==l){var h=[];0!==r.length&&h.push(this.mergeIntoSlice(0,e.length,r));let s=[];for(;0!==o.length;){let e=o[0],t=e.position,n=Math.max(0,t-20),r=Math.min(i.length,t+100);s.push(this.mergeIntoSlice(n,r,o))}s.sort((e,t)=>e.count!==t.count?t.count-e.count:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);r=parseInt(this.top_n_per_article,10);0<=r&&(s=s.slice(0,r));let t="";(n=new URL(n,location.origin)).searchParams.append("highlight",c.join(" ")),t+=0!==h.length?`<div class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${this.highlightKeyword(e,h[0])}</span>`:`<div class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${e}</span>`,s.forEach(e=>{t+=`<p class="search-result">${this.highlightKeyword(i,e)}...</p></a>`}),t+="</div>",d.push({item:t,id:d.length,hitCount:l,includedCount:a})}}),d}fetchData(){let t=!this.path.endsWith("json");fetch(this.path).then(e=>e.text()).then(e=>{this.isfetched=!0,this.datas=t?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e),this.datas=this.datas.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),window.dispatchEvent(new Event("search:loaded"))})}highlightText(t,e,r){var s=t.nodeValue;let i=e.start;var a=[];for(let{position:t,length:n}of e.hits){let e=document.createTextNode(s.substring(i,t));i=t+n;var o=document.createElement("mark");o.className=r,o.appendChild(document.createTextNode(s.substr(t,n))),a.push(e,o)}t.nodeValue=s.substring(i,e.end),a.forEach(e=>{t.parentNode.insertBefore(e,t)})}highlightSearchWords(e){let t=new URL(location.href).searchParams.get("highlight"),n=t?t.split(" "):[];if(n.length&&e){for(var r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),s=[];r.nextNode();)r.currentNode.parentNode.matches("button, select, textarea, .mermaid")||s.push(r.currentNode);s.forEach(e=>{var[t]=this.getIndexByWord(n,e.nodeValue);t.length&&(t=this.mergeIntoSlice(0,e.nodeValue.length,t),this.highlightText(e,t,"search-keyword"))})}}}window.addEventListener("load",()=>{let{path:e,top_n_per_article:t,unescape:n,languages:s}=GLOBAL_CONFIG.localSearch,i=new LocalSearch({path:e,top_n_per_article:t,unescape:n}),a=document.querySelector("#local-search-input input"),o=document.getElementById("local-search-stats-wrap"),l=document.getElementById("loading-status"),h=!e.endsWith("json"),r=()=>{if(i.isfetched){let t=a.value.trim().toLowerCase(),e=(""!==(t=h?t.replace(/</g,"&lt;").replace(/>/g,"&gt;"):t)&&(l.innerHTML='<i class="fas fa-spinner fa-pulse"></i>'),t.split(/[-\s]+/)),n=document.getElementById("local-search-results"),r=[];if(0<t.length&&(r=i.getResultItems(e)),1===e.length&&""===e[0])n.textContent="",o.textContent="";else if(0===r.length){n.textContent="";let e=document.createElement("div");e.className="search-result-stats",e.textContent=s.hits_empty.replace(/\$\{query}/,t),o.innerHTML=e.outerHTML}else{r.sort((e,t)=>e.includedCount!==t.includedCount?t.includedCount-e.includedCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let e=s.hits_stats.replace(/\$\{hits}/,r.length);n.innerHTML=`<div class="search-result-list">${r.map(e=>e.item).join("")}</div>`,o.innerHTML=`<hr><div class="search-result-stats">${e}</div>`,window.pjax&&window.pjax.refresh(n)}l.textContent=""}},c=!1,d=document.getElementById("search-mask"),u=document.querySelector("#local-search .search-dialog"),g=()=>{window.innerWidth<768&&u.style.setProperty("--search-height",window.innerHeight+"px")},p=()=>{var e=document.body.style;e.width="100%",e.overflow="hidden",btf.animateIn(d,"to_show 0.5s"),btf.animateIn(u,"titleScale 0.5s"),setTimeout(()=>{a.focus()},300),c||(i.isfetched||i.fetchData(),a.addEventListener("input",r),c=!0),document.addEventListener("keydown",function e(t){"Escape"===t.code&&(m(),document.removeEventListener("keydown",e))}),g(),window.addEventListener("resize",g)},m=()=>{var e=document.body.style;e.width="",e.overflow="",btf.animateOut(u,"search_close .5s"),btf.animateOut(d,"to_hide 0.5s"),window.removeEventListener("resize",g)},f=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",p)};window.addEventListener("search:loaded",()=>{var e=document.getElementById("loading-database");e.nextElementSibling.style.display="block",e.remove()}),f(),document.querySelector("#local-search .search-close-button").addEventListener("click",m),d.addEventListener("click",m),GLOBAL_CONFIG.localSearch.preload&&i.fetchData(),i.highlightSearchWords(document.getElementById("article-container")),window.addEventListener("pjax:complete",()=>{btf.isHidden(d)||m(),i.highlightSearchWords(document.getElementById("article-container")),f()})});